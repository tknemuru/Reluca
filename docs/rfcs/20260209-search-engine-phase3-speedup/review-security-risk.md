## Security & Risk Reviewer によるレビュー結果

### 1. 判定 (Decision)

- **Status**: Approve

**判定基準:** P0 が1件以上存在する場合は Request Changes とする。P0 が0件の場合は Approve とする。

### 2. 良い点 (Strengths)

- **5.2.5 パス処理時のハッシュ管理**: パス処理時の `hash ^= TurnKey` による差分更新と、`context.Turn = prevTurn` による復元が try/finally で保護されており、TT 不整合のリスクが解消されている。
- **5.4.3 逆引きテーブルと Initialize の整合性**: `Initialize` メソッド内で `BuildSquareToPatterns()` を呼び出す設計が明記されており、パターン定義と逆引きテーブルの不整合リスクが緩和されている。
- **5.4.4 パターンインデックスの保存・復元方式**: `PatternIndexChange` 構造体による差分記録方式が具体的に設計されており、UnmakeMove 時の復元が逆順で実行される設計が適切である。
- **5.1.5 MoveAndReverseUpdater の位置づけ**: 探索エンジン外（UI 層）での用途を維持しつつ、探索エンジンからの依存を削除する方針が明確に記載されており、移行リスクが管理されている。

### 3. 指摘事項 (Issues)

#### Severity 定義

| Severity | 名称 | 定義 | Author の対応 |
| :--- | :--- | :--- | :--- |
| **P0 (Blocker)** | 修正必須 | 論理的欠陥、仕様漏れ、重大なリスク、回答必須の質問 | 必ず対応 |
| **P1 (Improvement)** | 具体的改善 | 修正内容と期待効果が明確な具体的改善提案 | 原則対応 |
| **P2 (Note)** | 記録のみ | 代替案の提示、将来的な懸念、参考情報 | 対応不要 |

#### 指摘一覧

**P0**: 該当なし

**[P1-1] PatternIndexChange バッファの再帰ネスト安全性の設計が不完全**
- **対象セクション**: 5.4.4 差分更新の統合とパターンインデックスの保存・復元方式
- **内容**: 本文中に「探索深さごとにバッファを分離するか、各 MoveInfo が変更記録の開始オフセットを保持する方式とする」と記載され、後段で「単一の大きな配列 + 開始オフセット方式」に言及しているが、`MaxDepth` と `MaxChangesPerMove` の具体的な値が定義されていない。実装時に不適切なバッファサイズを設定すると、深い探索でバッファオーバーフローが発生するリスクがある。
- **修正の期待値**: `MaxDepth`（想定される最大探索深さ、例: 64）と `MaxChangesPerMove`（1 手あたりの最大パターン変更数、例: 128）の具体的な値を定義し、合計バッファサイズの上限（例: `64 * 128 = 8,192` エントリ、約 100KB）を 5.4.4 に追記する。
