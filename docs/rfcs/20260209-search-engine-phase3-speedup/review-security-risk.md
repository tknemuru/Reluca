## Security & Risk Reviewer によるレビュー結果

### 1. 判定 (Decision)

- **Status**: Approve

**判定基準:** P0 が1件以上存在する場合は Request Changes とする。P0 が0件の場合は Approve とする。

### 2. 良い点 (Strengths)

設計上の重要な判断で妥当と評価できるものを簡潔に記載する。

- 7.4 マイグレーションと後方互換性: 公開インターフェースを一切変更せず、内部実装のみの最適化とする方針が明確であり、後方互換性リスクが最小化されている。
- 9. リスク軽減策: デバッグアサーションによる差分更新の正しさ検証とフォールバック機構が設計されており、差分更新に問題が発生した場合にフルスキャン版に戻せる構造が担保されている。
- 5.3.2 PopCount: .NET 8.0 ランタイムのソフトウェアフォールバック（POPCNT 非対応 CPU）について明記されており、ハードウェア依存による障害リスクが適切に軽減されている。
- 9. 実装・リリース計画: 段階的導入により Step 1 のみでもリリース可能とする設計は、リスクの段階的な管理として優れている。
- 7.1 セキュリティとプライバシー: 本改善がパフォーマンス最適化のみであり、セキュリティ・プライバシーへの影響がないことが明記されている。

### 3. 指摘事項 (Issues)

#### Severity 定義

| Severity | 名称 | 定義 | Author の対応 |
| :--- | :--- | :--- | :--- |
| **P0 (Blocker)** | 修正必須 | 論理的欠陥、仕様漏れ、重大なリスク、回答必須の質問 | 必ず対応 |
| **P1 (Improvement)** | 具体的改善 | 修正内容と期待効果が明確な具体的改善提案 | 原則対応 |
| **P2 (Note)** | 記録のみ | 代替案の提示、将来的な懸念、参考情報 | 対応不要 |

#### 指摘一覧

**P0**: 該当なし

**[P1-1] Zobrist ハッシュ差分更新の UnmakeMove 時復元方式に関するリスク**
- **対象セクション**: 5.2.5 PvsSearchEngine への統合
- **内容**: MoveInfo に `PrevHash` を保持し UnmakeMove 時に復元する設計が示されているが、パス処理（`Pvs` メソッド内の合法手 0 個のケース）でのハッシュ値管理が明記されていない。パス時は `TurnKey` の XOR のみ必要だが、パス処理は MakeMove/UnmakeMove パターンを使用せず `BoardAccessor.Pass` を直接呼んでいるため、ハッシュの差分更新がパス処理で適用されない場合に TT Probe/Store で不整合が発生するリスクがある。
- **修正の期待値**: パス処理時のハッシュ値差分更新（`hash ^= TurnKey`）の実装方針を 5.2.5 に追記し、パス → 復元のフローでハッシュ値が正しく管理されることを設計レベルで保証すること。

**[P1-2] 評価関数差分更新の逆引きテーブル構築時における初期化順序の依存リスク**
- **対象セクション**: 5.4.3 マス → パターン逆引きテーブル
- **内容**: 逆引きテーブルは `FeaturePatternExtractor` のコンストラクタ内でリソースから読み込んだパターン定義に基づいて構築される必要があるが、`FeaturePatternExtractor` は `Initialize` メソッドによる後からの再初期化もサポートしている。逆引きテーブルが `Initialize` 呼び出し時に再構築されない場合、パターン定義と逆引きテーブルの不整合が発生し、差分更新が誤った結果を返すリスクがある。
- **修正の期待値**: `Initialize` メソッドでの逆引きテーブル再構築の要否を設計に明記し、`Initialize` 後も差分更新が正しく動作することを保証する方針を追記すること。

**[P2-1] 探索結果の数値的一致に関する検証の網羅性**
- **対象セクション**: 8. テスト戦略 - 回帰テスト
- **内容**: 「同一局面・同一深さでの探索結果（最善手・評価値）は変化しない」としているが、MPC やAspiration Window の挙動は TT の内容に依存し、ハッシュ計算方式の変更（フルスキャン → 差分更新）でTTヒット率が微妙に変化する可能性（差分更新導入中のテスト段階でフルスキャンと差分更新が混在する過渡期など）がある。過渡期の挙動についても考慮しておくと安全である。
