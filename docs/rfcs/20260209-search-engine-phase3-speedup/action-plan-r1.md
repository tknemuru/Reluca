# レビュー統合アクションプラン（ラウンド 1）

## 判定
- **Status**: Request Changes
- **P0 件数**: 3 件
- **P1 件数**: 5 件（アクション対象: 5 件）
- **P2 件数**: 5 件（記録のみ）

## 必須対応 (P0)

**[P0-1] MakeMove における裏返し処理のビットボード化と MoveAndReverseUpdater の責務が未定義**
- **出典**: Approach (P0-2), Quality (P0-1)
- **内容**: RFC は `BitboardMobilityGenerator.ComputeFlipped` による裏返し処理のビットボード化を提案し、`MobilityAnalyzer` からの `MoveAndReverseUpdater` 依存を排除する設計を示している。しかし、`PvsSearchEngine.MakeMove` は現在 `_reverseUpdater.Update(context)` を呼び出して着手を実行しており、この呼び出しがビットボード版にどう置換されるかの具体的な設計が欠落している。`MoveAndReverseUpdater` の着手実行モードの位置づけ（廃止、共存、ラッパー化）が不明確であり、実装時に設計判断が分散するリスクがある。
- **修正方針**: (1) `PvsSearchEngine.MakeMove` 内で `_reverseUpdater.Update(context)` を `BitboardMobilityGenerator.ComputeFlipped` + ビットボード演算に置換する具体的なコード例を 5.1.3 または 5.1.4 に追記する。(2) ビットボード化後の `MoveAndReverseUpdater` の位置づけ（探索エンジン外の UI 用途等で残すか、完全に廃止するか）を明記する。(3) `flipped` ビットボードが MakeMove の戻り値または MoveInfo 経由で Zobrist 差分更新・評価関数差分更新に伝播される経路を設計する。

**[P0-2] Zobrist ハッシュ値の伝播設計およびパス処理時の管理が未定義**
- **出典**: Quality (P0-2), Security (P1-1)
- **内容**: RFC は「ルートで `ComputeHash` を 1 回呼び、以降は `UpdateHash` で差分更新」と記載しているが、ハッシュ値を `Pvs` メソッドの引数として渡すのか、`GameContext` のフィールドとして保持するのか、`MoveInfo` から復元するのかの具体的な伝播方式が設計されていない。加えて、パス処理（合法手 0 個のケース）では MakeMove/UnmakeMove パターンを使用せず `BoardAccessor.Pass` を直接呼んでいるため、ハッシュ値の差分更新（`hash ^= TurnKey`）がパス処理で適用されない場合に TT の不整合が発生するリスクがある。また、MPC の浅い探索ではフルウィンドウで `Pvs` を呼ぶため、ハッシュ値の伝播がこのケースでも正しく機能する必要がある。
- **修正方針**: (1) ハッシュ値の伝播方式（メソッド引数方式 or コンテキストフィールド方式）を決定し、5.2.5 に明記する。(2) `Pvs` メソッド、パス処理、MPC 浅い探索、`RootSearch`、`OptimizeMoveOrder` それぞれでのハッシュ値管理の具体的なコード例を追記する。(3) パス処理時の `hash ^= TurnKey` の実装と復元のフローを設計レベルで保証する。

**[P0-3] FindFlips のマスク適用方向の正しさの根拠が不足**
- **出典**: Approach (P0-1)
- **内容**: `FindFlips` で各方向に適用されるマスク（`NotAFile`, `NotHFile`）が正しいことの論理的根拠が RFC 内に記載されていない。特に対角線方向（shift = 9, -9, 7, -7）で片側の列マスクのみ適用している理由が不明確である。`ComputeFlippedDirection`（5.1.3）でも同一のマスク対応が使われるため、両者の一貫性も明示すべきである。
- **修正方針**: 各方向のシフト量とマスクの対応表を作成し、「右方向（shift=1）ではプレイヤー石を左シフトするため、A列のビットが H列に回り込むのを防止する NotAFile を opponent に適用する」等の形式で、8 方向全てについて回り込み防止の根拠を 5.1.2 に補足として追記する。

## 推奨対応 (P1) -- 上位5件

**[P1-1] 性能改善の定量的な検証基準の定義**
- **出典**: Approach (P1-1)
- **内容**: 「同一局面・同一深さでの探索速度を Phase 2 完了時点から 2〜5 倍に改善する」と記載されているが、具体的なベンチマーク条件（局面、探索深さ、計測回数、NPS の計算方法）が定義されていない。
- **修正方針**: ベンチマーク条件（使用局面 2〜3 種類、探索深さ、計測回数、ウォームアップ回数、NPS 計算式）を 7.2 または 9 に追記し、各ステップの「成果物」欄に NPS 比較レポートの具体的な計測条件を記載する。

**[P1-2] 評価関数差分更新のパターンインデックス保存・復元方式の具体化**
- **出典**: Quality (P1-2)
- **内容**: 「差分情報のみ保存する方式」と記載されているが、具体的なデータ構造とメモリレイアウトが示されていない。MakeMove/UnmakeMove のホットパス上にあるため、パフォーマンスに直結する設計判断である。
- **修正方針**: パターンインデックスの保存・復元に使用するデータ構造を決定する。候補: (A) `MoveInfo` 内に固定サイズの `Span<int>` + `stackalloc` バッファ、(B) `_preallocatedResults` の差分のみを MoveInfo に記録（変更前の値と変更位置のペア配列）。いずれかを選択し、5.4.4 に追記する。

**[P1-3] 評価関数差分更新の逆引きテーブルと Initialize メソッドの整合性保証**
- **出典**: Security (P1-2)
- **内容**: `FeaturePatternExtractor.Initialize` による再初期化時に逆引きテーブルが再構築されない場合、パターン定義と逆引きテーブルの不整合が発生し、差分更新が誤った結果を返すリスクがある。
- **修正方針**: `Initialize` メソッド内で逆引きテーブルの再構築を行う方針を 5.4.3 に追記する。または、差分更新導入後は `Initialize` による動的な再初期化を非推奨とし、コンストラクタでの 1 回限りの初期化に限定する設計判断を明記する。

**[P1-4] 可観測性メトリクスの充実**
- **出典**: Quality (P1-1)
- **内容**: Phase 3 の各最適化の個別効果を計測する手段が NPS 追加のみでは不十分である。各最適化の寄与度を定量的に評価するためのメトリクスが必要である。
- **修正方針**: デバッグビルド限定で、各最適化の個別効果を計測するカウンタ（ビットボード合法手生成回数、Zobrist 差分更新回数 vs フルスキャン回数、評価関数差分更新あたりの平均影響マス数/パターン数）を 7.3 に追記する。

**[P1-5] Phase 3 開始条件のトレーサビリティ確保**
- **出典**: Approach (P1-2)
- **内容**: Phase 1/2 の PR 番号やブランチ名への具体的な参照がなく、開始条件の確認が困難である。
- **修正方針**: Phase 1/2 の RFC パス（`docs/rfcs/20260209-search-engine-perf-improvement/rfc.md`）および対応する PR 番号を 3. 目的とスコープの Phase 3 開始条件テーブルに追記する。

## 記録のみ (P2)

- 評価関数差分更新の計算量見積もりにおいて、コーナー付近のマスの影響パターン数が 8 を超える可能性があり、高速化倍率が局面に依存する可能性がある（出典: Approach）
- `ToMoveList` が `List<int>` を新規生成する点は Phase 1/2 の GC アロケーション削減方針との整合性に懸念がある。`Span<int>` + `stackalloc` による代替も検討に値する（出典: Approach）
- ハッシュ計算方式の過渡期（フルスキャンと差分更新の混在）における TT ヒット率の微妙な変化が探索結果に影響する可能性がある（出典: Security）
- `FindFlips` 内の `shift > 0` 分岐が JIT インライン化後もブランチ予測に負荷を与える可能性がある。方向ごとの専用メソッド展開も将来的に検討に値する（出典: Quality）
- `ConvertToTernaryIndex` の MSB 側からの計算方式と差分更新の LSB 側からの重み前提の間に計算方向の違いがあり、実装時の整合性検証が必要である（出典: Quality）

## 要判断（矛盾する指摘）

該当なし
