## Security & Risk Reviewer によるレビュー結果

### 1. 判定 (Decision)

- **Status**: Approve

**判定基準:** P0 が1件以上存在する場合は Request Changes とする。P0 が0件の場合は Approve とする。

### 2. 良い点 (Strengths)

- **セキュリティ影響の明確な宣言（セクション 7.1）**: パフォーマンス最適化であり、セキュリティ・プライバシーへの影響がないことを明示的に宣言しており、レビュー範囲が明確である。
- **後方互換性の分析（セクション 7.4）**: ISearchEngine.Search のインターフェース不変、BoardContext の内部使用限定、探索結果の不変性（パスの変化のみ）など、互換性への影響を網羅的に分析している。
- **段階的リリースによるリスク軽減（セクション 9）**: Phase 1 と Phase 2 を独立してリリース可能とし、各ステップ完了ごとにテスト通過を確認する計画は、障害発生時の影響範囲を最小化する適切なリスク軽減策である。
- **並行実装による安全な移行（セクション 9）**: Phase 2 の MakeMove/UnmakeMove 導入時に既存の DeepCopy 方式を残しつつ並行実装し、結果一致を検証してから切り替える計画は、移行リスクを適切に管理している。

### 3. 指摘事項 (Issues)

#### Severity 定義

| Severity | 名称 | 定義 | Author の対応 |
| :--- | :--- | :--- | :--- |
| **P0 (Blocker)** | 修正必須 | 論理的欠陥、仕様漏れ、重大なリスク、回答必須の質問 | 必ず対応 |
| **P1 (Improvement)** | 具体的改善 | 修正内容と期待効果が明確な具体的改善提案 | 原則対応 |
| **P2 (Note)** | 記録のみ | 代替案の提示、将来的な懸念、参考情報 | 対応不要 |

#### 指摘一覧

**P0:**

該当なし

**[P1-1] UnmakeMove の状態復元漏れリスクに対するフェイルセーフが未設計**
- **対象セクション**: 5.2.1 MakeMove/UnmakeMove パターンへの移行
- **内容**: MakeMove/UnmakeMove パターンでは、探索中に例外が発生した場合（SearchTimeoutException 等）、UnmakeMove が呼ばれずに盤面が不整合な状態になるリスクがある。現行の DeepCopy 方式ではコピーが独立しているため元の盤面に影響はないが、in-place 方式ではこの安全性が失われる。
- **修正の期待値**: 探索中の例外発生時にも盤面状態が安全に復元される設計を明記する。例えば try/finally による UnmakeMove の保証、または探索開始前のルート盤面バックアップによるフォールバック機構を設計に追加する。

**[P1-2] ExtractNoAlloc の内部バッファ共有に伴う将来的なマルチスレッド化リスク**
- **対象セクション**: 5.1.4 FeaturePatternExtractor.Extract のアロケーション排除
- **内容**: シングルスレッド前提で内部バッファを共有する設計であるが、Non-Goals にマルチスレッド探索が含まれており、将来的にマルチスレッド化する可能性がある。その際、ExtractNoAlloc のバッファ共有がデータ競合の原因となりうる。
- **修正の期待値**: ExtractNoAlloc のドキュメントコメントに「シングルスレッド専用」の制約を明記し、マルチスレッド化時には ThreadLocal バッファまたはインスタンス分離が必要である旨を注記する。

**[P2-1] record struct 化に伴う意図しない値コピーによるパフォーマンス劣化リスク**
- **対象セクション**: 5.2.2 BoardContext を record struct に変更
- **内容**: BoardContext を値型にすると、引数渡しやプロパティアクセス時に暗黙の値コピーが発生する。16 バイト（ulong 2 つ）であればコピーコストは小さいが、将来的に BoardContext にフィールドが追加された場合、コピーコストが増大するリスクがある。また、意図しないボクシング（interface 型への代入等）が発生した場合、逆にアロケーションが増加する。

**[P2-2] Phase 2 のロールバック手順が未定義**
- **対象セクション**: 9. 実装・リリース計画 / リスク軽減策
- **内容**: Phase 2 の構造的変更（特に MakeMove/UnmakeMove + record struct 化）が探索結果に予期しない影響を与えた場合のロールバック手順が明示されていない。並行実装で結果一致を検証する計画はあるが、本番切り替え後に問題が発見された場合の復旧方法が不明確である。ただし、RFC-driven Development Workflow のセクション 4 でロールバックの一般的な手順が定義されているため、大きな問題ではない。
