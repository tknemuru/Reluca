# レビュー統合アクションプラン（ラウンド 1）

## 判定
- **Status**: Request Changes
- **P0 件数**: 2 件
- **P1 件数**: 5 件（アクション対象: 5 件）
- **P2 件数**: 4 件（記録のみ）

## 必須対応 (P0)

**[P0-1] G1 の達成確認方法がデバッグログ依存であり、自動検証が定義されていない**
- **出典**: Approach
- **内容**: G1 の Verification が「デバッグログで確認する」「ログから確認する」となっており、自動化された検証手段が定義されていない。テスト戦略（セクション8）では `SearchResult.CompletedDepth` を検証する単体テストが記述されているが、G1 の Verification との対応関係が不明確である。
- **修正方針**: G1 の Verification を「終盤局面で `SearchResult.CompletedDepth` が `64 - PopCount(black | white)` 以下であることを単体テストで検証する」と具体化し、セクション8 のテスト戦略と整合させること。

**[P0-2] 対策3 の `evaluator is FeaturePatternEvaluator` による型判定が開放閉鎖原則に違反している**
- **出典**: Quality
- **内容**: `usePatternIncremental = evaluator is FeaturePatternEvaluator` という型判定は、将来新しい評価関数が追加された際に `PvsSearchEngine` の修正を強いる。評価関数がパターンインデックスを必要とするかどうかは評価関数自身の責務であり、探索エンジンが具象型で判定すべきではない。
- **修正方針**: 評価関数のインターフェースに `bool RequiresPatternIndex { get; }` のようなプロパティを追加し、`usePatternIncremental = evaluator.RequiresPatternIndex` とすること。

## 推奨対応 (P1) -- 上位5件

**[P1-1] 対策3 の `_usePatternIncremental` フラグの例外時リセット未定義**
- **出典**: Security
- **内容**: `_usePatternIncremental` フィールドが `Search` メソッドで設定され `MakeMove`/`UnmakeMove` で参照される設計であるが、`SearchTimeoutException` 発生時のフラグリセットが明記されていない。
- **修正方針**: `Search` メソッドの `finally` ブロックまたは `SearchTimeoutException` ハンドラ内で `_usePatternIncremental` を `false` にリセットする処理を設計に追記すること。

**[P1-2] 対策2 の連続パス検出が `Pvs` メソッド以外の探索パスを網羅しているかの分析が欠如**
- **出典**: Quality
- **内容**: RFC では `Pvs` メソッドのみを変更対象としているが、PVS の全ウィンドウ再探索パスなど、他の探索パスにも同様のパス処理が存在する可能性がある。網羅性の確認が記載されていない。
- **修正方針**: `PvsSearchEngine` 内でパス処理を行うすべてのメソッド・パスを列挙し、連続パス検出の修正が必要な箇所を網羅的に特定した結果を RFC に追記すること。

**[P1-3] 対策2 の `Evaluate` の符号の正当性に関する確認の欠如**
- **出典**: Security
- **内容**: 連続パス時に `return Evaluate(context)` を呼び出すが、`Pvs` メソッドは再帰時に `-Pvs(...)` と符号反転を行っている。`Evaluate` が現在の `context.Turn` 視点の評価値を返すことの確認が RFC 上で明示されていない。
- **修正方針**: `Evaluate(context)` が現在の `context.Turn` 視点の評価値を返すことを RFC 内で明記し、符号の正当性を確認した旨を記載すること。

**[P1-4] テスト戦略のデバッグカウンタ設計詳細が未定義**
- **出典**: Quality
- **内容**: 対策3 のテストで `_debugPatternDeltaUpdateCount` というデバッグカウンタを検証すると記述されているが、定義場所、アクセス修飾子、条件コンパイル有無、テストからのアクセス方法が未定義である。
- **修正方針**: デバッグカウンタの実装方針を RFC に追記するか、デバッグカウンタに依存せず `_usePatternIncremental` フラグの値を検証する方法への変更を検討すること。

**[P1-5] フリーズ解消の定量的根拠が不足している**
- **出典**: Approach
- **内容**: 対策1 で排除される depth=15〜99 のループは「合法手が0になるため即座に返る」とも記述されており、85回のループ排除だけではフリーズ解消の主因にならない可能性がある。3つの対策のうちどれがフリーズ解消に最も寄与するかの分析が不足している。
- **修正方針**: 3つの対策それぞれの削減効果の大小関係を定性的にでも記載し、フリーズ解消に最も寄与する対策を明確化すること。

## 記録のみ (P2)

- 対策1 における空きマス数計算の補足説明不足: `Black | White` の PopCount には初期配置の石も含まれるため正確な空きマス数が得られる旨の補足があると読者に親切である。（出典: Approach）
- UI 非同期化の将来的な必要性に対するタイムラインの欠如: 案B の対応時期に関する目安が示されていない。（出典: Approach）
- 対策1 と対策2 の組み合わせにおける残り空きマス数1〜2の極端な終盤局面のエッジケーステストが望ましい。（出典: Security）
- 可観測性の設計が既存ログ基盤への依存のみで、対策の効果を定量的に計測するメトリクスが設計に含まれていない。（出典: Quality）

## 要判断（矛盾する指摘）

該当なし
