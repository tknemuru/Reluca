# Domain Model

## 概要

Reluca はオセロ（リバーシ）の思考エンジンである。8×8 の盤面上で黒石と白石を交互に配置し、相手の石を挟んで裏返すゲームをモデル化している。盤面はビットボード（64 ビット整数）で表現し、高速な合法手生成と着手処理を実現する。

## ドメイン概念

### Disc（石）

石の色を表す。

| 値 | 説明 |
|---|---|
| `Undefined` | 不確定（初期状態） |
| `Black` | 黒石（先手） |
| `White` | 白石（後手） |

### Board（盤面）

8×8 = 64 マスの盤面を表す。

| 定数 | 値 | 説明 |
|---|---|---|
| `Length` | 8 | 盤の一辺の長さ |
| `AllLength` | 64 | 盤の全マス目数 |

盤面の状態:

| 状態 | 説明 |
|---|---|
| `Empty` | 空きマス |
| `Mobility` | 着手可能マス |
| `Black` | 黒石が置かれている |
| `White` | 白石が置かれている |

### Player（プレイヤー）

対局者の種類を表す。

| 値 | 説明 |
|---|---|
| `Human` | 人間（手動入力） |
| `Cpu` | CPU（思考エンジン） |

### Stage（ステージ）

ゲームの進行度を表す。評価関数の重みはステージごとに異なる。

| 定数 | 値 | 説明 |
|---|---|---|
| `Unit` | 4 | 1 ステージあたりのターン数 |
| `Max` | 15 | 最大ステージ値 |

ゲームは最大 60 手（初期配置 4 石 + 60 手 = 64 マス）で終了し、15 ステージに分割される。

## データ構造

### 盤面表現（ビットボード）

盤面は 2 つの `ulong`（64 ビット整数）で表現する。各ビットが盤面の 1 マスに対応する。

```
  a b c d e f g h
1 0 1 2 3 4 5 6 7
2 8 9 ...
3 ...
4       27 28        (初期配置: 黒=27,36 白=28,35)
5       35 36
6 ...
7 ...
8             ... 63
```

| フィールド | 型 | 説明 |
|---|---|---|
| `Black` | `ulong` | 黒石の配置（ビット 1 = 黒石あり） |
| `White` | `ulong` | 白石の配置（ビット 1 = 白石あり） |

### BoardContext（盤面コンテキスト）

盤面の状態を保持する record 型。

```csharp
public record BoardContext
{
    public ulong Black { get; set; }  // 黒石の配置
    public ulong White { get; set; }  // 白石の配置
}
```

### GameContext（ゲームコンテキスト）

ゲーム全体の状態を保持する record 型。

```csharp
public record GameContext
{
    public BoardContext Board { get; set; }  // 盤面状態
    public ulong Mobility { get; set; }      // 着手可能位置
    public int TurnCount { get; set; }       // ターン数
    public int Stage { get; set; }           // ステージ
    public Disc.Color Turn { get; set; }     // 手番
    public int Move { get; set; }            // 指し手（0-63）
}
```

## 特徴パターン

局面評価に使用する 13 種類のパターン。各パターンは盤面上の特定の位置の石の配置を数値化したもの。

### 線形パターン

| パターン | 桁数 | 説明 |
|---|---|---|
| `Diag4` | 4 | 対角線（4 マス） |
| `Diag5` | 5 | 対角線（5 マス） |
| `Diag6` | 6 | 対角線（6 マス） |
| `Diag7` | 7 | 対角線（7 マス） |
| `Diag8` | 8 | 主対角線（8 マス） |
| `HorVert2` | 8 | 水平/垂直線（2 列目） |
| `HorVert3` | 8 | 水平/垂直線（3 列目） |
| `HorVert4` | 8 | 水平/垂直線（4 列目） |

### 領域パターン

| パターン | 桁数 | 説明 |
|---|---|---|
| `Edge2X` | 10 | 辺 + X マス |
| `Corner2X5` | 10 | 隅 2×5 領域 |
| `Corner3X3` | 9 | 隅 3×3 領域 |

### 特殊パターン

| パターン | 説明 |
|---|---|
| `Parity` | 手番によるパリティ（黒番=1, 白番=0） |
| `Mobility` | 着手可能数の差（黒の合法手数 - 白の合法手数） |

### パターンのエンコード

各マスの状態を 3 進数でエンコードする:

| 状態 | 値 |
|---|---|
| White | 0 |
| Empty | 1 |
| Black | 2 |

例: 4 マスのパターン [Black, Empty, White, Black] = 2×3³ + 1×3² + 0×3¹ + 2×3⁰ = 54 + 9 + 0 + 2 = 65

## 状態遷移

### ゲームフロー

```
┌─────────────┐
│  初期化     │  InitializeUpdater
│  (4石配置)  │  - 黒: d5, e4
└──────┬──────┘  - 白: d4, e5
       │
       ▼
┌─────────────┐
│  着手可能   │  MobilityAnalyzer / MobilityUpdater
│  位置計算   │  - 8方向の裏返し可能性を判定
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│  着手あり?                          │
│  ├─ Yes → 着手実行                  │
│  │         MoveAndReverseUpdater    │
│  │         - 石を配置               │
│  │         - 挟まれた石を裏返す     │
│  │                                  │
│  └─ No → パス                       │
│           BoardAccessor.Pass()      │
│           - 手番のみ交代            │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────┐
│  終了判定   │  GameEndJudge
│             │  - 両者とも着手不可 → 終了
└──────┬──────┘  - 盤面が埋まった → 終了
       │
       ├─ 続行 → 手番交代して着手可能位置計算へ
       │
       └─ 終了 → 石数カウントで勝敗判定
```

### 着手処理の詳細

1. **着手位置の決定**: 探索エンジンまたはプレイヤー入力により 0-63 の位置を決定
2. **石の配置**: 指定位置に手番の石を配置（ビット OR）
3. **裏返し**: 8 方向に対して挟まれた相手の石を裏返す
4. **手番交代**: `Turn` を反転、`TurnCount` をインクリメント
5. **ステージ更新**: `TurnCount / Stage.Unit` でステージを計算

### 終局条件

- 両プレイヤーとも合法手がない（連続パス）
- 盤面が全て埋まった（60 手完了）

### 勝敗判定

終局時の石数差で判定:

| 条件 | 結果 |
|---|---|
| 黒石 > 白石 | 黒の勝ち |
| 黒石 < 白石 | 白の勝ち |
| 黒石 = 白石 | 引き分け |
