# 強化ロードマップ v2

## 背景

Phase 1〜3 の性能最適化および終盤フリーズ修正がすべてマージされ、探索エンジンの速度面での改善が完了した。この先は **「同じ時間でより賢い手を選ぶ」** フェーズへ移行する。

### 完了済みの実装

| フェーズ | 内容 | ステータス |
|---------|------|-----------|
| Phase 1 | DI排除、AnalyzeCount、LINQ排除、ExtractNoAlloc | 完了 |
| Phase 2 | MakeMove/UnmakeMove、BoardContext値型化、Null Window Search、Aspiration二重探索排除 | 完了 |
| Phase 3 | ビットボード合法手生成、Zobristハッシュ差分更新、PopCount、評価関数差分更新 | 完了 |
| 終盤修正 | 反復深化上限・連続パス検出・パターン差分更新スキップ・終盤MPC無効化 | 完了 |

### 未実装で残っている主要機能

| 機能 | 状態 |
|------|------|
| Killer Move / History Heuristic | 未実装 |
| 定石ブック（Opening Book） | 未実装 |
| 並列探索（マルチスレッド） | 未実装（設計で除外中） |
| NodesSearched 計測（Task 3e） | 未完了 |
| MPC パラメータ最適化 | 基本実装済み・チューニング未着手 |
| Aspiration Window チューニング | 基本実装済み・チューニング未着手 |

---

## Phase 4: 計測基盤と手順序改善

**目的**: 改善の効果を定量化する基盤を作り、探索効率を直接改善する

**効果/難易度比**: ★★★★★（即効性高・リスク低）

| # | タスク | 概要 | 期待効果 |
|---|--------|------|----------|
| 4a | **NodesSearched 計測** | SearchResult に探索ノード数・NPS を追加。ベンチマーク基盤の確立 | 以降の全改善の定量評価が可能に |
| 4b | **Killer Move Heuristic** | 兄弟ノードでカットを起こした手を記憶し、同じ深さの他ノードで優先的に試行 | 探索ノード 10〜20% 削減 |
| 4c | **History Heuristic** | カットを起こした手を (from, to) 別にカウントし、手順序のスコアに加算 | 探索ノード 5〜15% 追加削減 |
| 4d | **Enhanced Move Ordering** | TT bestMove → Killer → History → 評価値ソートの統合的な手順序 | 4b+4c の効果を最大化 |

### 選定理由

手順序改善は「同じ深さでもノード数を減らす」最も費用対効果の高い手法。Killer Move は実装が簡単で効果が大きい。

---

## Phase 5: 定石ブック

**目的**: 序盤の計算時間をゼロにし、既知の最善手を即座に返す

**効果/難易度比**: ★★★★☆（序盤劇的改善・独立性高）

| # | タスク | 概要 | 期待効果 |
|---|--------|------|----------|
| 5a | **定石データ構造設計** | トライ木 or ハッシュマップ形式の定石テーブル。局面正規化（回転・反転の8対称）対応 | 定石ブック基盤 |
| 5b | **Thor データベース取り込み** | 公開されている Thor データベース（数十万局の棋譜）からの定石抽出パイプライン | 高品質な定石データ |
| 5c | **定石ブック参照の統合** | FindBestMover で探索前に定石ブックを参照。ヒットすれば即座に返す | 序盤10〜15手を即座に応答（探索不要） |
| 5d | **定石ブック拡張機構** | 自分の対局結果から定石ブックを更新・拡張する機能（WZebra の「Book Learning」に相当） | 対局を重ねるほど強化 |

### 選定理由

序盤は計算で最善手を見つけるのが困難な一方、既知の定石は高品質。WZebra も定石ブックを重要視している。

---

## Phase 6: MPC・Aspiration チューニングと終盤強化

**目的**: 既存アルゴリズムのパラメータを最適化し、終盤の読み切り精度を向上

**効果/難易度比**: ★★★☆☆（効果大だがデータ分析が必要）

| # | タスク | 概要 | 期待効果 |
|---|--------|------|----------|
| 6a | **MPC パラメータ自動チューニング** | Thor データベースの局面群に対して回帰分析を実行し、ステージ別の (a, b, σ) を最適化 | 枝刈り精度向上。不要なカット減少・必要なカット増加 |
| 6b | **Aspiration Window チューニング** | delta 初期値・拡張係数をステージ別に最適化。fail 率の統計収集と分析 | 再探索頻度の削減 → 実効探索速度向上 |
| 6c | **Fastest-First Heuristic** | 終盤で「合法手が少ないノードを先に展開する」手順序。空きマス数を基準にソート | 終盤探索木の効率的な縮小 |
| 6d | **Parity-based Move Ordering** | 終盤で「相手の領域に先に打つ」ヒューリスティック。偶数理論に基づく手順序 | 終盤のカット率向上 |
| 6e | **Stability Analysis** | 安定石（もう裏返らない石）の高速計算。評価関数の精度向上に寄与 | 評価精度の改善 |

### 選定理由

MPC は Reluca の探索効率の核心だが、パラメータが手動設定のまま。自動チューニングで大幅な改善が見込める。終盤特化手法は WZebra の強さの重要な柱。

---

## Phase 7: 並列探索とアーキテクチャ進化

**目的**: マルチコア活用による探索速度の倍増と、長期的な成長基盤

**効果/難易度比**: ★★☆☆☆（効果最大だが実装リスク高）

| # | タスク | 概要 | 期待効果 |
|---|--------|------|----------|
| 7a | **Lazy SMP** | 複数スレッドで同じルート局面を異なる深さで並列探索。共有 TT で情報共有 | 実装が比較的簡単で、コア数に近い速度向上（2〜4倍） |
| 7b | **並列探索対応の TT 改修** | lock-free 読み書き or ストライプドロックの TT 実装 | 並列探索のボトルネック排除 |
| 7c | **YBWC（Young Brothers Wait Concept）** | PV ノードの最初の手が完了してから残りを並列化。より効率的だが実装複雑 | Lazy SMP より理論的効率が高い |
| 7d | **対局サーバ対応** | GTP-like プロトコルや NBoard プロトコルでの対局機能 | 他のオセロ AI との自動対局・レーティング測定 |

### 選定理由

現在シングルスレッド前提。Lazy SMP は実装難易度が低い割に効果が大きく、最初の並列化ステップとして最適。

---

## 優先順位の判断基準

```
効果/難易度 の比率が高い順:

Phase 4 (手順序改善)     ★★★★★  即効性高・リスク低
Phase 5 (定石ブック)     ★★★★☆  序盤劇的改善・独立性高
Phase 6 (チューニング)   ★★★☆☆  効果大だがデータ分析が必要
Phase 7 (並列探索)       ★★☆☆☆  効果最大だが実装リスク高
```

---

## 採用しないアプローチ（と理由）

| 候補 | 不採用理由 |
|------|------------|
| **NNUE（ニューラルネットワーク評価関数）** | パターンベース評価で十分な精度。学習基盤の構築コストが高すぎる |
| **MCTS（モンテカルロ木探索）** | Alpha-Beta 系探索がオセロでは優位。PVS+MPC 路線を維持すべき |
| **Endgame Solver（完全読み切り DB）** | 6x6 以下なら有効だが 8x8 では現実的でない |
